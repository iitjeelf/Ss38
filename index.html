<script>
const MARK_PER_CORRECT=1,MARK_PER_WRONG=-0.25;
let images=["1.png","2.png","3.png","4.png","5.png","6.png"];
let answerKey=["A","B","C","D","A","B"];
const subjects=["Maths","Physics","Chemistry"];
let examData={files:[],subjectNames:[],keys:[]};
let progress=null,timerInterval=null;

function shuffleArray(arr){const c=arr.slice();for(let i=c.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[c[i],c[j]]=[c[j],c[i]];}return c;}

function prepareExamData(){
  examData.files=[];examData.subjectNames=[];examData.keys=[];
  const total=images.length,base=Math.floor(total/3);
  let remainder=total%3,start=0,groups=[];
  for(let s=0;s<3;s++){
    const count=base+(remainder>0?1:0); remainder--;
    const imgs=images.slice(start,start+count);
    const keys=answerKey.slice(start,start+count); start+=count;
    const idxs=shuffleArray([...Array(imgs.length).keys()]);
    groups.push({name:subjects[s],imgs:idxs.map(i=>imgs[i]),keys:idxs.map(i=>keys[i])});
  }
  shuffleArray(groups).forEach(g=>g.imgs.forEach((img,i)=>{examData.files.push(img);examData.keys.push(g.keys[i]);examData.subjectNames.push(g.name);}));
}

function validateStudentInputs(){
  const n=stuName,s=stuSection,r=stuRoll,a=stuAdm;
  let v1=/^[A-Za-z .]+$/.test(n.value),v2=/^[A-Za-z0-9]+$/.test(s.value),
      v3=/^[0-9]+$/.test(r.value),v4=/^[0-9]+$/.test(a.value);
  n.classList.toggle('error',!v1&&n.value!==""); s.classList.toggle('error',!v2&&s.value!=="");
  r.classList.toggle('error',!v3&&r.value!==""); a.classList.toggle('error',!v4&&a.value!=="");
  stuStartBtn.style.display=(v1&&v2&&v3&&v4)?"inline-block":"none";
  return v1&&v2&&v3&&v4;
}
["stuName","stuSection","stuRoll","stuAdm"].forEach(id=>document.getElementById(id).addEventListener("input",validateStudentInputs));

function showConfirm(msg,cb){
  confirmText.textContent=msg;
  confirmModal.style.display="flex";
  confirmYes.onclick=()=>{confirmModal.style.display="none";cb(true);};
  confirmNo.onclick=()=>{confirmModal.style.display="none";cb(false);};
}

// --- MODIFIED START BUTTON LOGIC ---
stuStartBtn.onclick = () => {
    // Immediately show red overlay before starting exam
    fullRedOverlay.style.display = "block";

    if (!validateStudentInputs()) {
        fullRedOverlay.style.display = "none"; // remove red if validation fails
        return;
    }

    // Check for 2+ same students within 24 hrs
    const allKeys = Object.keys(localStorage);
    const now = Date.now();
    let count = 0;
    const currentInput = `${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
    allKeys.forEach(key => {
        if (key.includes(`${stuName.value}|${stuSection.value}|${stuRoll.value}`)) {
            const stored = localStorage.getItem(key);
            if (stored && now - stored < 86400000) count++;
        }
    });

    if (count >= 2) {
        accessDeniedBox.style.display = "block";
        callAdminBtn.onclick = () => {
            adminPassModal.style.display = "flex";
            adminPassSubmit.onclick = () => {
                if (adminPassInput.value === "lfjc2025") {
                    adminPassModal.style.display = "none";
                    fullRedOverlay.style.display = "none";
                    accessDeniedBox.style.display = "none";
                    startExam(currentInput);
                } else {
                    alert("Incorrect password!");
                }
            };
        };
    } else {
        startWithSecurity(true);
    }
};

function startWithSecurity(ok){
  if(!ok)return;
  const studentKey=`${stuName.value}|${stuSection.value}|${stuRoll.value}|${stuAdm.value}`;
  const stored=localStorage.getItem(studentKey),now=Date.now();
  if(stored && now-stored<86400000){
    fullRedOverlay.style.display="block"; accessDeniedBox.style.display="block";
    callAdminBtn.onclick=()=>{
      adminPassModal.style.display="flex";
      adminPassSubmit.onclick=()=>{
        if(adminPassInput.value==="lfjc2025"){
          adminPassModal.style.display="none";
          fullRedOverlay.style.display="none"; accessDeniedBox.style.display="none";
          startExam(studentKey);
        }else alert("Incorrect password!");
      };
    };
  } else startExam(studentKey);
}

function startExam(studentKey){
  localStorage.setItem(studentKey,Date.now());
  prepareExamData();
  progress={answers:Array(examData.files.length).fill(null),review:Array(examData.files.length).fill(false),
  currentIndex:0,student:{name:stuName.value,sec:stuSection.value,roll:stuRoll.value,adm:stuAdm.value},timeLeftSec:5*60};

  studentEntry.style.display="none";
  examArea.style.display="block";
  renderQuestion(); renderPalette(); startTimer(); updateNavButtons();
}

function startTimer(){
  timerInterval=setInterval(()=>{
    if(progress.timeLeftSec<=0){clearInterval(timerInterval);submitExam();return;}
    progress.timeLeftSec--;
    let m=Math.floor(progress.timeLeftSec/60), s=progress.timeLeftSec%60;
    timerEl.textContent=`ðŸ•’ ${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    stuInfo.textContent=`${progress.student.name} | ${progress.student.sec} | ${progress.student.roll} | ${progress.student.adm}`;
    stuQInfo.textContent = `${examData.subjectNames[progress.currentIndex]} (Q ${progress.currentIndex + 1}/${examData.files.length})`;

    if(progress.timeLeftSec <= 300 && progress.timeLeftSec > 60){
        timerEl.classList.add("blink");
    } else { timerEl.classList.remove("blink"); }

    if(progress.timeLeftSec <= 60){
        timerEl.classList.add("blink");
        examHeader.classList.add("blinkLine");
    } else {
        examHeader.classList.remove("blinkLine");
    }
  },1000);
}

function renderQuestion(){
  const i=progress.currentIndex,f=examData.files[i],sub=examData.subjectNames[i];
  questionContainer.innerHTML=`<div class="sectionTitle">${sub} (Q ${i+1}/${examData.files.length})</div>
  <img src="${f}" class="questionImg"><br>`;
  ["A","B","C","D"].forEach(opt=>{
    let b=document.createElement("button"); b.className="optBtn"; b.textContent=opt;
    if(progress.answers[i]===opt)b.classList.add("selected");
    b.onclick=()=>{progress.answers[i]=(progress.answers[i]===opt?null:opt); renderPalette(); renderQuestion();};
    questionContainer.appendChild(b);
  });
}

prevBtn.onclick=()=>{if(progress.currentIndex>0){progress.currentIndex--;renderQuestion();renderPalette();updateNavButtons();}};
nextBtn.onclick=()=>{if(progress.currentIndex<examData.files.length-1){progress.currentIndex++;renderQuestion();renderPalette();updateNavButtons();}};
markReviewBtn.onclick=()=>{progress.review[progress.currentIndex]=!progress.review[progress.currentIndex];markReviewBtn.textContent=progress.review[progress.currentIndex]?"Unreview":"Review";renderPalette();};
submitBtn.onclick=()=>showConfirm("Submit Exam?",x=>{if(x)submitExam();});

function updateNavButtons(){
  prevBtn.style.display=progress.currentIndex===0?"none":"inline-block";
  nextBtn.style.display=progress.currentIndex===examData.files.length-1?"none":"inline-block";
  markReviewBtn.textContent=progress.review[progress.currentIndex]?"Unreview":"Review";
}

function renderPalette(){
  paletteContainer.innerHTML="";
  progress.answers.forEach((ans,i)=>{
    const b=document.createElement("button"); b.textContent=i+1;
    if(progress.review[i])b.classList.add("reviewed");
    if(i===progress.currentIndex)b.classList.add("current");
    if(ans)b.classList.add("selected");
    b.onclick=()=>{progress.currentIndex=i;renderQuestion();renderPalette();updateNavButtons();};
    paletteContainer.appendChild(b);
  });
}

document.addEventListener("visibilitychange",()=>{
  if(document.hidden && progress) submitExam();
});

function submitExam(){
  clearInterval(timerInterval);
  const subjData={};
  examData.subjectNames.forEach((s,i)=>{
    if(!subjData[s])subjData[s]={correct:0,wrong:0,blank:0,total:0};
    const ans=progress.answers[i];
    if(ans===null)subjData[s].blank++;
    else if(ans===examData.keys[i])subjData[s].correct++;
    else subjData[s].wrong++;
    subjData[s].total++;
  });

  let html=`<h2 style="color:#4B0082;">ðŸŽ‰ Congratulations, ${progress.student.name}</h2>
  <div><b>Section:</b> ${progress.student.sec} | <b>Roll:</b> ${progress.student.roll} | <b>Admission No:</b> ${progress.student.adm}</div>
  <br>
  <div style="overflow-x:auto;display:flex;justify-content:center;width:100%;">
  <table border="1" style="border-collapse:collapse;width:95%;max-width:900px;text-align:center;font-size:18px;">
  <tr style="background:#E6E6FA;">
    <th>Subject</th><th>Correct</th><th>Wrong</th><th>Blank</th><th>Total</th><th>Percentage</th>
  </tr>`;

  let totalCorrect=0,totalWrong=0,totalBlank=0,totalQs=0;

  for(let s in subjData){
    let v=subjData[s];
    let per=((v.correct/v.total)*100).toFixed(2);
    totalCorrect+=v.correct; totalWrong+=v.wrong; totalBlank+=v.blank; totalQs+=v.total;
    html+=`<tr><td>${s}</td><td>${v.correct}</td><td>${v.wrong}</td><td>${v.blank}</td><td>${v.total}</td><td>${per}%</td></tr>`;
  }

  let totalPer=((totalCorrect/totalQs)*100).toFixed(2);

  html+=`<tr style="font-weight:bold;background:#D8BFD8;">
    <td>Total</td><td>${totalCorrect}</td><td>${totalWrong}</td><td>${totalBlank}</td><td>${totalQs}</td><td>${totalPer}%</td>
  </tr></table></div><br><button id="logoutBtn" class="glow">Logout</button>`;

  examArea.innerHTML=html;

  // --- MODIFIED LOGOUT ---
  logoutBtn.onclick = () => {
      progress = null;
      examArea.innerHTML = "<h2>Logged out. You can close this tab now.</h2>";
      window.close();
  }
}
</script>
